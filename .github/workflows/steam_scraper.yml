name: Steam Lua Stable Collector ğŸ›¡ï¸

on:
  workflow_dispatch:
    inputs:
      github_token:
        description: 'GitHub Token'
        required: true
      search_target:
        description: 'å…¨ç½‘æœç´¢ç›®æ ‡æ•°é‡'
        required: true
        default: '50'
  schedule:
    - cron: '0 16 * * *'

permissions:
  contents: write

jobs:
  stable-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Fetch depth=1)
        uses: actions/checkout@v3
        with:
          fetch-depth: 1 # åªæ‹‰å–æœ€æ–°ä¸€æ¬¡æäº¤ï¼ŒåŠ å¿« 3ä¸‡ä¸ªæ–‡ä»¶çš„ä¸‹è½½é€Ÿåº¦

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install PyGithub requests

      - name: Run Stable Script
        env:
          USER_INPUT_TOKEN: ${{ inputs.github_token }}
          SEARCH_TARGET: ${{ inputs.search_target || '20' }}
        run: |
          cat << 'EOF' > collector.py
          import os
          import time
          import shutil
          import subprocess
          import requests
          import concurrent.futures
          from github import Github, RateLimitExceededException

          # === é…ç½® ===
          SEARCH_TARGET = int(os.environ.get('SEARCH_TARGET', 20))
          TOKEN = os.environ.get('USER_INPUT_TOKEN')
          SAVE_DIR = "lua_downloads"
          MARKER_FILE = ".luatool_imported"
          
          LUATOOL_REPO = "https://github.com/usercat280297/Luatool.git"
          MANIFEST_REPO = "https://github.com/SteamAutoCracks/ManifestHub.git"

          search_added_count = 0

          # å¼ºåˆ¶åˆ·æ–°æ—¥å¿—ï¼Œé˜²æ­¢å¡åœ¨ç¼“å†²åŒº
          def log(msg):
              print(f"[System] {msg}", flush=True)

          def ensure_dir(path):
              if not os.path.exists(path):
                  os.makedirs(path)

          def is_numeric_lua(filename):
              if not filename.endswith('.lua'): return False
              return filename[:-4].isdigit()

          # === æ ¸å¿ƒå·¥å…·ï¼šå¸¦è¶…æ—¶çš„ Git å‘½ä»¤ ===
          def git_run(args, cwd=None, timeout=30):
              """æ‰§è¡Œ git å‘½ä»¤ï¼Œè¶…æ—¶è‡ªåŠ¨æ€æ‰ï¼Œå¹¶ä¸”ä¸è¾“å‡ºä»»ä½•åºŸè¯"""
              try:
                  subprocess.run(
                      args, 
                      cwd=cwd, 
                      check=True, 
                      stdout=subprocess.DEVNULL, # é™éŸ³æ ‡å‡†è¾“å‡º
                      stderr=subprocess.DEVNULL, # é™éŸ³é”™è¯¯è¾“å‡º (å†ä¹Ÿä¸ä¼šçœ‹åˆ° hint äº†)
                      timeout=timeout            # è¶…æ—¶å¼ºé€€
                  )
                  return True
              except subprocess.TimeoutExpired:
                  log(f"âš ï¸ Git å‘½ä»¤è¶…æ—¶ (>{timeout}s): {' '.join(args)}")
                  return False
              except Exception:
                  return False

          # === 1. å…¨ç½‘ä»“åº“æœç´¢ ===
          def check_and_download_file(file_info):
              raw_url, filename, repo_name = file_info
              save_path = os.path.join(SAVE_DIR, filename)
              if os.path.exists(save_path): return False

              try:
                  resp = requests.get(raw_url, timeout=5) # 5ç§’ç½‘ç»œè¶…æ—¶
                  if resp.status_code == 200:
                      content = resp.text
                      if 'addappid' in content:
                          if not os.path.exists(save_path):
                              with open(save_path, 'w', encoding='utf-8') as f:
                                  f.write(content)
                              return True
              except: pass
              return False

          def process_repo_search():
              global search_added_count
              if not TOKEN: 
                  log("æ—  Tokenï¼Œè·³è¿‡æœç´¢")
                  return

              log(f"--- å¯åŠ¨å…¨ç½‘æœç´¢ (ç›®æ ‡: {SEARCH_TARGET}) ---")
              g = Github(TOKEN)
              query = "steam OR manifest language:Lua"
              
              try:
                  repos = g.search_repositories(query=query, sort="updated", order="desc")
                  scanned = 0
                  
                  for repo in repos:
                      if search_added_count >= SEARCH_TARGET: break
                      if scanned >= 80: break # ç¨å¾®å‡å°‘æ‰«æä¸Šé™ï¼Œé˜²æ­¢è¶…æ—¶
                      scanned += 1
                      
                      if os.environ.get("GITHUB_REPOSITORY") == repo.full_name: continue

                      try:
                          # log(f"æ‰«æ: {repo.full_name}") 
                          # å¢åŠ  timeout é˜²æ­¢è·å–æ–‡ä»¶æ ‘å¡æ­»
                          tree = repo.get_git_tree(repo.default_branch, recursive=True).tree
                          
                          candidates = []
                          for element in tree:
                              fname = os.path.basename(element.path)
                              if is_numeric_lua(fname):
                                  if not os.path.exists(os.path.join(SAVE_DIR, fname)):
                                      raw_url = f"https://raw.githubusercontent.com/{repo.full_name}/{repo.default_branch}/{element.path}"
                                      candidates.append((raw_url, fname, repo.full_name))

                          if not candidates: continue

                          # å¹¶å‘ä¸‹è½½
                          with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
                              results = list(executor.map(check_and_download_file, candidates))
                          
                          added = sum(results)
                          if added > 0:
                              search_added_count += added
                              log(f"âœ… {repo.full_name} è´¡çŒ®äº† {added} ä¸ªæ–°æ–‡ä»¶")
                              
                      except Exception: continue
                      
              except Exception as e:
                  log(f"æœç´¢ä¸­æ–­: {e}")

          # === 2. Luatool (Git Clone) ===
          def process_luatool():
              if os.path.exists(MARKER_FILE):
                  log("Luatool å·²å®Œæˆï¼Œè·³è¿‡")
                  return

              log("--- å¤„ç† Luatool ---")
              temp_dir = "temp_luatool"
              count = 0
              try:
                  if os.path.exists(temp_dir): shutil.rmtree(temp_dir)
                  # ä½¿ç”¨å°è£…çš„ git_runï¼Œé™éŸ³ + è¶…æ—¶
                  if git_run(["git", "clone", "--depth=1", LUATOOL_REPO, temp_dir]):
                      src_dir = os.path.join(temp_dir, "lua_files")
                      if os.path.exists(src_dir):
                          for fname in os.listdir(src_dir):
                              if is_numeric_lua(fname):
                                  dst = os.path.join(SAVE_DIR, fname)
                                  if not os.path.exists(dst):
                                      try:
                                          src = os.path.join(src_dir, fname)
                                          with open(src, 'r', encoding='utf-8', errors='ignore') as f:
                                              if 'addappid' in f.read():
                                                  shutil.copy2(src, dst)
                                                  count += 1
                                      except: pass
                      
                      with open(MARKER_FILE, 'w') as f: f.write("done")
                      log(f"Luatool æ–°å¢: {count}")
                  else:
                      log("Luatool Clone å¤±è´¥æˆ–è¶…æ—¶")
                      
              finally:
                  if os.path.exists(temp_dir): shutil.rmtree(temp_dir)

          # === 3. ManifestHub (Git Fetch) ===
          def process_manifesthub():
              log("--- å¤„ç† ManifestHub ---")
              count = 0
              temp_repo = "temp_manifest"
              
              try:
                  # 1. è·å–è¿œç¨‹åˆ—è¡¨ (è¶…æ—¶ä¿æŠ¤)
                  # è¿™é‡Œä¸ä½¿ç”¨ git_run å°è£…å› ä¸ºéœ€è¦è·å–è¾“å‡º
                  ls_proc = subprocess.run(
                      ["git", "ls-remote", "--heads", MANIFEST_REPO], 
                      capture_output=True, text=True, timeout=30
                  )
                  
                  branches_to_fetch = []
                  for line in ls_proc.stdout.splitlines():
                      parts = line.split('\t')
                      if len(parts) > 1:
                          b_name = parts[1].replace('refs/heads/', '')
                          if b_name.isdigit():
                              if not os.path.exists(os.path.join(SAVE_DIR, f"{b_name}.lua")):
                                  branches_to_fetch.append(b_name)

                  if not branches_to_fetch:
                      log("æ²¡æœ‰å‘ç°æ–° Manifest æ–‡ä»¶")
                      return

                  log(f"ManifestHub å‘ç° {len(branches_to_fetch)} ä¸ªæ–°åˆ†æ”¯ï¼Œå¼€å§‹åŒæ­¥...")

                  if not os.path.exists(temp_repo):
                      os.makedirs(temp_repo)
                      # åˆå§‹åŒ– gitï¼Œé™éŸ³
                      git_run(["git", "init", temp_repo])
                      git_run(["git", "-C", temp_repo, "remote", "add", "origin", MANIFEST_REPO])

                  # åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ 50 ä¸ª
                  batch_size = 50
                  for i in range(0, len(branches_to_fetch), batch_size):
                      batch = branches_to_fetch[i:i+batch_size]
                      
                      # Fetch è¿™ä¸€æ‰¹ (é™éŸ³ + è¶…æ—¶)
                      # å¦‚æœè¿™ä¸€æ­¥å¡ä½è¶…è¿‡ 60ç§’ï¼Œä¼šè‡ªåŠ¨è·³è¿‡è¿™ä¸€æ‰¹
                      if not git_run(["git", "-C", temp_repo, "fetch", "origin"] + batch + ["--depth=1"], timeout=60):
                          continue

                      for branch in batch:
                          try:
                              # è¯»å–æ–‡ä»¶å†…å®¹
                              proc = subprocess.run(
                                  ["git", "-C", temp_repo, "show", f"FETCH_HEAD:{branch}.lua"], 
                                  capture_output=True, text=True, errors='ignore', timeout=5
                              )
                              content = proc.stdout
                              
                              # å¤‡ç”¨æŸ¥æ‰¾é€»è¾‘ (é˜²æ­¢æ–‡ä»¶ä¸åœ¨æ ¹ç›®å½•)
                              if not content:
                                  ls_proc = subprocess.run(
                                      ["git", "-C", temp_repo, "ls-tree", "-r", "--name-only", "FETCH_HEAD"], 
                                      capture_output=True, text=True, timeout=5
                                  )
                                  for fpath in ls_proc.stdout.splitlines():
                                      if fpath.endswith('.lua'):
                                          content = subprocess.run(
                                              ["git", "-C", temp_repo, "show", f"FETCH_HEAD:{fpath}"], 
                                              capture_output=True, text=True, errors='ignore', timeout=5
                                          ).stdout
                                          break
                              
                              if content and 'addappid' in content:
                                  with open(os.path.join(SAVE_DIR, f"{branch}.lua"), 'w', encoding='utf-8') as f:
                                      f.write(content)
                                  count += 1
                          except: pass
                          
                  log(f"ManifestHub æ–°å¢: {count}")

              except subprocess.TimeoutExpired:
                  log("ManifestHub æ“ä½œè¶…æ—¶ï¼Œè·³è¿‡")
              except Exception as e:
                  log(f"ManifestHub é”™è¯¯: {e}")
              finally:
                  if os.path.exists(temp_repo): shutil.rmtree(temp_repo)

          # === æ‰§è¡Œ ===
          ensure_dir(SAVE_DIR)
          
          process_repo_search()
          process_luatool()
          process_manifesthub()
          
          log("æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•")
          EOF

          python collector.py

      - name: Commit and Push
        run: |
          git config --global user.name "StableBot"
          git config --global user.email "bot@github.com"
          git add lua_downloads/
          if [ -f .luatool_imported ]; then git add .luatool_imported; fi
          # é˜²æ­¢æ²¡æœ‰æ–‡ä»¶æ—¶æŠ¥é”™
          git commit -m "Auto update lua files" || echo "No changes to commit"
          git push
