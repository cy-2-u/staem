name: Steam Lua Turbo Collector ğŸš€

on:
  workflow_dispatch:
    inputs:
      github_token:
        description: 'GitHub Token (ç”¨äºæœç´¢ä»“åº“)'
        required: true
      search_target:
        description: 'å…¨ç½‘æœç´¢æ–°å¢ç›®æ ‡æ•°é‡ (è¾¾åˆ°å³åœ)'
        required: true
        default: '50'
  schedule:
    # åŒ—äº¬æ—¶é—´ 00:00 (UTC 16:00)
    - cron: '0 16 * * *'

permissions:
  contents: write

jobs:
  turbo-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install PyGithub requests

      - name: Run Turbo Script
        env:
          USER_INPUT_TOKEN: ${{ inputs.github_token }}
          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æœç´¢ 20 ä¸ªï¼Œé¿å…è¶…æ—¶
          SEARCH_TARGET: ${{ inputs.search_target || '20' }}
        run: |
          cat << 'EOF' > collector.py
          import os
          import time
          import shutil
          import subprocess
          import requests
          import concurrent.futures
          from github import Github, RateLimitExceededException

          # === å…¨å±€é…ç½® ===
          SEARCH_TARGET = int(os.environ.get('SEARCH_TARGET', 50))
          TOKEN = os.environ.get('USER_INPUT_TOKEN')
          SAVE_DIR = "lua_downloads"
          MARKER_FILE = ".luatool_imported"
          
          # å›ºå®šæº
          LUATOOL_REPO = "https://github.com/usercat280297/Luatool.git"
          MANIFEST_REPO = "https://github.com/SteamAutoCracks/ManifestHub.git"

          # å…¨å±€è®¡æ•°å™¨
          search_added_count = 0

          def log(msg):
              print(f"[System] {msg}")

          def ensure_dir(path):
              if not os.path.exists(path):
                  os.makedirs(path)

          def is_numeric_lua(filename):
              if not filename.endswith('.lua'):
                  return False
              name = filename[:-4]
              return name.isdigit()

          # === ä»»åŠ¡ 1: é«˜æ€§èƒ½å…¨ç½‘ä»“åº“æœç´¢ ===
          def check_and_download_file(file_info):
              """
              å¤šçº¿ç¨‹å·¥ä½œå•å…ƒï¼šä¸‹è½½å¹¶éªŒè¯å•ä¸ªæ–‡ä»¶
              file_info: (raw_url, filename, repo_name)
              """
              raw_url, filename, repo_name = file_info
              save_path = os.path.join(SAVE_DIR, filename)
              
              # åŒé‡æ£€æŸ¥ï¼ˆé˜²æ­¢çº¿ç¨‹å†²çªï¼‰
              if os.path.exists(save_path):
                  return False

              try:
                  # è®¾ç½® 5 ç§’è¶…æ—¶ï¼Œè¿½æ±‚é€Ÿåº¦ï¼Œæ…¢çš„ç›´æ¥ä¸¢å¼ƒ
                  resp = requests.get(raw_url, timeout=5)
                  if resp.status_code == 200:
                      content = resp.text
                      if 'addappid' in content:
                          # å†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆå†™å…¥é”é€»è¾‘ç®€åŒ–ç‰ˆï¼‰
                          if not os.path.exists(save_path):
                              with open(save_path, 'w', encoding='utf-8') as f:
                                  f.write(content)
                              return True
              except:
                  pass
              return False

          def process_repo_search():
              global search_added_count
              if not TOKEN:
                  log("âŒ æ—  Tokenï¼Œè·³è¿‡å…¨ç½‘æœç´¢")
                  return

              log(f"--- å¯åŠ¨å…¨ç½‘ä»“åº“æœç´¢ (ç›®æ ‡æ–°å¢: {SEARCH_TARGET}) ---")
              g = Github(TOKEN)
              
              # æœç´¢è¯­æ³•ï¼šåŒ…å« steam æˆ– manifestï¼Œä¸”è¯­è¨€æ˜¯ Lua
              # GitHub é»˜è®¤ä¼šæœç´¢ Name, Description, Readme
              query = "steam OR manifest language:Lua"
              
              try:
                  # æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œä¼˜å…ˆçœ‹æœ€è¿‘æ´»è·ƒçš„ä»“åº“
                  repos = g.search_repositories(query=query, sort="updated", order="desc")
                  
                  # é™åˆ¶æ‰«æçš„ä»“åº“æ•°é‡ï¼Œé˜²æ­¢è„šæœ¬è¿è¡Œå‡ å¤©å‡ å¤œ
                  repo_scan_limit = 100 
                  scanned = 0

                  for repo in repos:
                      if search_added_count >= SEARCH_TARGET:
                          log("ğŸ‰ å·²è¾¾åˆ°æœç´¢æ–°å¢ç›®æ ‡ï¼Œåœæ­¢æœç´¢")
                          break
                      
                      if scanned >= repo_scan_limit:
                          log("å·²æ‰«æ 100 ä¸ªä»“åº“ï¼Œæœ¬è½®æœç´¢ç»“æŸ")
                          break

                      scanned += 1
                      
                      # æ’é™¤è‡ªå·±
                      if os.environ.get("GITHUB_REPOSITORY") == repo.full_name:
                          continue

                      try:
                          # log(f"æ‰«æä»“åº“: {repo.full_name}") # å¤ªåµå¯ä»¥æ³¨é‡Š
                          
                          # è·å–ä»“åº“æ–‡ä»¶æ ‘ (recursive=True ä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰æ–‡ä»¶)
                          # æ³¨æ„ï¼šå¤§ä»“åº“å¯èƒ½ä¼šæ…¢ï¼Œä½†æ¯”ä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶å¤¹ç‚¹è¿›å»å¿«
                          try:
                              tree = repo.get_git_tree(repo.default_branch, recursive=True).tree
                          except:
                              continue # å¯èƒ½æ˜¯ç©ºä»“åº“æˆ–æ²¡æƒé™

                          # ç­›é€‰å‡ºæ‰€æœ‰ç¬¦åˆæ ¼å¼çš„å€™é€‰æ–‡ä»¶
                          candidates = []
                          for element in tree:
                              filename = os.path.basename(element.path)
                              if is_numeric_lua(filename):
                                  # åªæœ‰æœ¬åœ°æ²¡æœ‰çš„æ‰åŠ å…¥ä¸‹è½½é˜Ÿåˆ—
                                  if not os.path.exists(os.path.join(SAVE_DIR, filename)):
                                      # æ„é€  raw url
                                      raw_url = f"https://raw.githubusercontent.com/{repo.full_name}/{repo.default_branch}/{element.path}"
                                      candidates.append((raw_url, filename, repo.full_name))

                          if not candidates:
                              continue

                          log(f"ğŸ” åœ¨ {repo.full_name} å‘ç° {len(candidates)} ä¸ªå€™é€‰æ–‡ä»¶ï¼Œå¹¶å‘éªŒè¯ä¸­...")

                          # === å¹¶å‘åŠ é€Ÿæ ¸å¿ƒ ===
                          # å¼€å¯ 10 ä¸ªçº¿ç¨‹åŒæ—¶ä¸‹è½½éªŒè¯
                          with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
                              results = list(executor.map(check_and_download_file, candidates))
                          
                          # ç»Ÿè®¡æˆåŠŸæ•°é‡
                          new_in_repo = sum(results)
                          if new_in_repo > 0:
                              search_added_count += new_in_repo
                              log(f"âœ… ä»è¯¥ä»“åº“æˆåŠŸæ•è· {new_in_repo} ä¸ªæ–°æ–‡ä»¶")

                          # ç¨å¾®ä¼‘æ¯ï¼Œä¿æŠ¤ API
                          time.sleep(1)

                      except Exception as e:
                          # print(f"ä»“åº“æ‰«æé”™è¯¯: {e}")
                          continue

              except RateLimitExceededException:
                  log("API é¢‘ç‡è¶…é™ï¼Œåœæ­¢æœç´¢")
              except Exception as e:
                  log(f"æœç´¢ä¸»æµç¨‹é”™è¯¯: {e}")

          # === ä»»åŠ¡ 2: Luatool (ä¿æŒåŸé€»è¾‘) ===
          def process_luatool():
              if os.path.exists(MARKER_FILE):
                  log("Luatool å·²æ ‡è®°å®Œæˆï¼Œè·³è¿‡")
                  return

              log("--- å¤„ç†å›ºå®šæº: Luatool ---")
              temp_dir = "temp_luatool"
              count = 0
              try:
                  if os.path.exists(temp_dir): shutil.rmtree(temp_dir)
                  subprocess.run(["git", "clone", "--depth=1", LUATOOL_REPO, temp_dir], check=True, stdout=subprocess.DEVNULL)
                  
                  source_folder = os.path.join(temp_dir, "lua_files")
                  if os.path.exists(source_folder):
                      for fname in os.listdir(source_folder):
                          if is_numeric_lua(fname):
                              dst = os.path.join(SAVE_DIR, fname)
                              if not os.path.exists(dst):
                                  src = os.path.join(source_folder, fname)
                                  try:
                                      with open(src, 'r', encoding='utf-8', errors='ignore') as f:
                                          if 'addappid' in f.read():
                                              shutil.copy2(src, dst)
                                              count += 1
                                  except: pass
                  with open(MARKER_FILE, 'w') as f: f.write("done")
                  log(f"Luatool æ–°å¢: {count}")
              except Exception as e: log(f"Luatool Error: {e}")
              finally:
                  if os.path.exists(temp_dir): shutil.rmtree(temp_dir)

          # === ä»»åŠ¡ 3: ManifestHub (ä¿æŒåŸé€»è¾‘) ===
          def process_manifesthub():
              log("--- å¤„ç†å›ºå®šæº: ManifestHub ---")
              count = 0
              try:
                  result = subprocess.run(["git", "ls-remote", "--heads", MANIFEST_REPO], capture_output=True, text=True)
                  branches_to_fetch = []
                  for line in result.stdout.splitlines():
                      parts = line.split('\t')
                      if len(parts) > 1:
                          b_name = parts[1].replace('refs/heads/', '')
                          if b_name.isdigit() and not os.path.exists(os.path.join(SAVE_DIR, f"{b_name}.lua")):
                              branches_to_fetch.append(b_name)

                  if branches_to_fetch:
                      log(f"ManifestHub å‘ç° {len(branches_to_fetch)} ä¸ªæ–°åˆ†æ”¯ï¼Œå¼€å§‹åŒæ­¥...")
                      temp_repo = "temp_manifest"
                      if not os.path.exists(temp_repo):
                          os.makedirs(temp_repo)
                          subprocess.run(["git", "init", temp_repo], stdout=subprocess.DEVNULL)
                          subprocess.run(["git", "-C", temp_repo, "remote", "add", "origin", MANIFEST_REPO], stdout=subprocess.DEVNULL)

                      batch_size = 50
                      for i in range(0, len(branches_to_fetch), batch_size):
                          batch = branches_to_fetch[i:i+batch_size]
                          subprocess.run(["git", "-C", temp_repo, "fetch", "origin"] + batch + ["--depth=1"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                          for branch in batch:
                              try:
                                  proc = subprocess.run(["git", "-C", temp_repo, "show", f"FETCH_HEAD:{branch}.lua"], capture_output=True, text=True, errors='ignore')
                                  content = proc.stdout
                                  if not content: # å¤‡ç”¨æŸ¥æ‰¾é€»è¾‘
                                      ls = subprocess.run(["git", "-C", temp_repo, "ls-tree", "-r", "--name-only", "FETCH_HEAD"], capture_output=True, text=True)
                                      for fpath in ls.stdout.splitlines():
                                          if fpath.endswith('.lua'):
                                              content = subprocess.run(["git", "-C", temp_repo, "show", f"FETCH_HEAD:{fpath}"], capture_output=True, text=True, errors='ignore').stdout
                                              break
                                  
                                  if content and 'addappid' in content:
                                      with open(os.path.join(SAVE_DIR, f"{branch}.lua"), 'w', encoding='utf-8') as f:
                                          f.write(content)
                                      count += 1
                              except: pass
                      log(f"ManifestHub æ–°å¢: {count}")
              except Exception as e: log(f"ManifestHub Error: {e}")
              finally:
                  if os.path.exists(temp_repo): shutil.rmtree(temp_repo)

          # === ä¸»ç¨‹åº ===
          ensure_dir(SAVE_DIR)
          
          # 1. ä¼˜å…ˆè¿è¡Œå…¨ç½‘ä»“åº“æœç´¢ (Token æ¶ˆè€—)
          process_repo_search()

          # 2. è¿è¡Œå›ºå®šæº (0 Token)
          process_luatool()
          process_manifesthub()
          
          log(f"ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚")
          EOF

          python collector.py

      - name: Commit and Push
        run: |
          git config --global user.name "LuaTurboBot"
          git config --global user.email "bot@github.com"
          git add lua_downloads/
          if [ -f .luatool_imported ]; then git add .luatool_imported; fi
          git commit -m "ğŸš€ Turbo update: Collected new lua files" || echo "No changes"
          git push
