name: Steam Lua Progress Collector ğŸ“Š

on:
  workflow_dispatch:
    inputs:
      search_target:
        description: 'å…¨ç½‘æœç´¢ç›®æ ‡æ•°é‡'
        required: true
        default: '50'
  schedule:
    - cron: '0 16 * * *'

permissions:
  contents: write

jobs:
  progress-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Fetch depth=1)
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install PyGithub requests

      - name: Run Script with Progress Bar
        env:
          # è‡ªåŠ¨è¯»å– Secretï¼Œä¸å†éœ€è¦ç”¨æˆ·è¾“å…¥
          USER_INPUT_TOKEN: ${{ secrets.AUTH_JSON }}
          SEARCH_TARGET: ${{ inputs.search_target || '50' }}
        run: |
          cat << 'EOF' > collector.py
          import os
          import time
          import shutil
          import subprocess
          import requests
          import json
          import datetime
          import concurrent.futures
          from github import Github, Auth

          # === é…ç½® ===
          SEARCH_TARGET = int(os.environ.get('SEARCH_TARGET', 50))
          SAVE_DIR = "lua_downloads"
          MARKER_FILE = ".luatool_imported"
          LOG_FILE = "update_log.txt"
          
          LUATOOL_REPO = "https://github.com/usercat280297/Luatool.git"
          MANIFEST_REPO = "https://github.com/SteamAutoCracks/ManifestHub.git"

          total_added_count = 0

          # === Token å¤„ç† (æ”¯æŒçº¯å­—ç¬¦ä¸²æˆ– JSON) ===
          raw_token = os.environ.get('USER_INPUT_TOKEN', '')
          TOKEN = raw_token
          if raw_token.strip().startswith('{'):
              try:
                  data = json.loads(raw_token)
                  # å°è¯•å¸¸è§çš„é”®åï¼Œæˆ–è€…ç›´æ¥å–ç¬¬ä¸€ä¸ªå€¼
                  TOKEN = data.get('token') or data.get('github_token') or list(data.values())[0]
                  print("[System] æ£€æµ‹åˆ° JSON æ ¼å¼å¯†é’¥ï¼Œå·²æå– Token")
              except:
                  print("[System] JSON è§£æå¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²")

          def log(msg):
              print(f"[System] {msg}", flush=True)

          def ensure_dir(path):
              if not os.path.exists(path):
                  os.makedirs(path)

          def is_numeric_lua(filename):
              if not filename.endswith('.lua'): return False
              return filename[:-4].isdigit()

          # === Git å·¥å…· ===
          def git_run(args, cwd=None, timeout=30):
              try:
                  subprocess.run(
                      args, cwd=cwd, check=True, 
                      stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, 
                      timeout=timeout
                  )
                  return True
              except:
                  return False

          # === 1. å…¨ç½‘æœç´¢ (ä¼˜åŒ–ç‰ˆ: é’ˆå¯¹ README æœç´¢) ===
          def check_and_download_file(file_info):
              raw_url, filename, repo_name = file_info
              save_path = os.path.join(SAVE_DIR, filename)
              if os.path.exists(save_path): return False
              try:
                  # ä¸‹è½½æ–‡ä»¶æ£€æŸ¥å†…å®¹
                  resp = requests.get(raw_url, timeout=5)
                  if resp.status_code == 200 and 'addappid' in resp.text:
                      if not os.path.exists(save_path):
                          with open(save_path, 'w', encoding='utf-8') as f:
                              f.write(resp.text)
                          return True
              except: pass
              return False

          def process_repo_search():
              global total_added_count
              if not TOKEN: 
                  log("âŒ æ—  Tokenï¼Œè·³è¿‡å…¨ç½‘æœç´¢")
                  return

              log(f"--- å¯åŠ¨å…¨ç½‘æœç´¢ (ç›®æ ‡: {SEARCH_TARGET}) ---")
              
              auth = Auth.Token(TOKEN)
              g = Github(auth=auth)
              
              # ä¼˜åŒ–æœç´¢æŸ¥è¯¢ï¼š
              # 1. in:readme -> åªåœ¨ README ä¸­æŸ¥æ‰¾å…³é”®è¯
              # 2. steam OR manifest OR lua -> å…³é”®è¯ (ä¸åŒºåˆ†å¤§å°å†™)
              # 3. language:Lua -> é™åˆ¶é¡¹ç›®ä¸»è¦è¯­è¨€ä¸º Luaï¼Œæé«˜å‡†ç¡®ç‡
              query = "steam OR manifest OR lua in:readme language:Lua"
              
              current_added = 0
              try:
                  repos = g.search_repositories(query=query, sort="updated", order="desc")
                  scanned = 0
                  
                  for repo in repos:
                      if current_added >= SEARCH_TARGET or scanned >= 100: break # é™åˆ¶æ‰«æä¸Šé™é˜²æ­¢è¶…æ—¶
                      
                      # è·³è¿‡è‡ªå·±
                      if os.environ.get("GITHUB_REPOSITORY") == repo.full_name: continue
                      
                      scanned += 1
                      try:
                          # è·å–ä»“åº“æ ‘ç»“æ„
                          tree = repo.get_git_tree(repo.default_branch, recursive=True).tree
                          candidates = []
                          for element in tree:
                              fname = os.path.basename(element.path)
                              # åªæœ‰æ–‡ä»¶åæ˜¯æ•°å­—çš„ lua æ–‡ä»¶æ‰ä¸‹è½½
                              if is_numeric_lua(fname) and not os.path.exists(os.path.join(SAVE_DIR, fname)):
                                  candidates.append((f"https://raw.githubusercontent.com/{repo.full_name}/{repo.default_branch}/{element.path}", fname, repo.full_name))

                          if candidates:
                              with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
                                  results = list(executor.map(check_and_download_file, candidates))
                              added = sum(results)
                              if added > 0:
                                  current_added += added
                                  total_added_count += added
                                  log(f"âœ… {repo.full_name} è´¡çŒ®äº† {added} ä¸ª")
                      except Exception as e: 
                          # log(f"è·³è¿‡ä»“åº“ {repo.full_name}: {e}")
                          continue
              except Exception as e:
                  log(f"æœç´¢ä¸­æ–­: {e}")
              
              log(f"å…¨ç½‘æœç´¢é˜¶æ®µç»“æŸï¼Œæœ¬è½®æ–°å¢: {current_added}")

          # === 2. Luatool (ä¿æŒä¸å˜ï¼Œæ£€æŸ¥ Marker) ===
          def process_luatool():
              global total_added_count
              if os.path.exists(MARKER_FILE):
                  log("Luatool æ ‡å¿—æ–‡ä»¶å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤")
                  return
              
              log("--- å¤„ç† Luatool ---")
              temp_dir = "temp_luatool"
              count = 0
              if os.path.exists(temp_dir): shutil.rmtree(temp_dir)
              
              if git_run(["git", "clone", "--depth=1", LUATOOL_REPO, temp_dir]):
                  src_dir = os.path.join(temp_dir, "lua_files")
                  if os.path.exists(src_dir):
                      for fname in os.listdir(src_dir):
                          if is_numeric_lua(fname):
                              dst = os.path.join(SAVE_DIR, fname)
                              if not os.path.exists(dst):
                                  try:
                                      with open(os.path.join(src_dir, fname), 'r', encoding='utf-8', errors='ignore') as f:
                                          if 'addappid' in f.read():
                                              shutil.copy2(os.path.join(src_dir, fname), dst)
                                              count += 1
                                  except: pass
                  # ç”Ÿæˆæ ‡å¿—æ–‡ä»¶
                  with open(MARKER_FILE, 'w') as f: f.write("done")
                  total_added_count += count
                  log(f"Luatool åˆå§‹åŒ–å®Œæˆï¼Œæ–°å¢: {count}")
              shutil.rmtree(temp_dir, ignore_errors=True)

          # === 3. ManifestHub (è¿›åº¦æ¡ç‰ˆ) ===
          def process_manifesthub():
              global total_added_count
              log("--- å¤„ç† ManifestHub ---")
              count = 0
              temp_repo = "temp_manifest"
              
              try:
                  log("æ­£åœ¨è·å–è¿œç¨‹åˆ†æ”¯åˆ—è¡¨...")
                  ls_proc = subprocess.run(
                      ["git", "ls-remote", "--heads", MANIFEST_REPO], 
                      capture_output=True, text=True, timeout=30
                  )
                  
                  branches = []
                  for line in ls_proc.stdout.splitlines():
                      parts = line.split('\t')
                      if len(parts) > 1:
                          b = parts[1].replace('refs/heads/', '')
                          if b.isdigit() and not os.path.exists(os.path.join(SAVE_DIR, f"{b}.lua")):
                              branches.append(b)

                  total_files = len(branches)
                  if total_files == 0:
                      log("ManifestHub æ— æ–°æ–‡ä»¶")
                      return

                  log(f"ManifestHub å‘ç° {total_files} ä¸ªæ–°æ–‡ä»¶")

                  if not os.path.exists(temp_repo):
                      os.makedirs(temp_repo)
                      git_run(["git", "init", temp_repo])
                      git_run(["git", "-C", temp_repo, "remote", "add", "origin", MANIFEST_REPO])

                  batch_size = 50
                  processed_count = 0
                  
                  for i in range(0, total_files, batch_size):
                      batch = branches[i:i+batch_size]
                      if git_run(["git", "-C", temp_repo, "fetch", "origin"] + batch + ["--depth=1"], timeout=60):
                          for branch in batch:
                              try:
                                  proc = subprocess.run(
                                      ["git", "-C", temp_repo, "show", f"FETCH_HEAD:{branch}.lua"], 
                                      capture_output=True, text=True, errors='ignore', timeout=5
                                  )
                                  content = proc.stdout
                                  if not content:
                                      # å¤‡ç”¨æŸ¥æ‰¾ç­–ç•¥
                                      ls = subprocess.run(["git", "-C", temp_repo, "ls-tree", "-r", "--name-only", "FETCH_HEAD"], capture_output=True, text=True, timeout=5).stdout
                                      if ls:
                                          for f in ls.splitlines():
                                              if f.endswith('.lua'):
                                                  content = subprocess.run(["git", "-C", temp_repo, "show", f"FETCH_HEAD:{f}"], capture_output=True, text=True, errors='ignore', timeout=5).stdout
                                                  break
                                  
                                  if content and 'addappid' in content:
                                      with open(os.path.join(SAVE_DIR, f"{branch}.lua"), 'w', encoding='utf-8') as f:
                                          f.write(content)
                                      count += 1
                              except: pass
                      
                      processed_count += len(batch)
                      # ç®€å•çš„è¿›åº¦æ—¥å¿—
                      if (i // batch_size) % 5 == 0 or processed_count >= total_files:
                          log(f"ManifestHub è¿›åº¦: {processed_count}/{total_files}")

                  total_added_count += count
                  log(f"ManifestHub åŒæ­¥å®Œæˆï¼Œå®é™…æ–°å¢: {count}")

              except Exception as e:
                  log(f"ManifestHub é”™è¯¯: {e}")
              finally:
                  shutil.rmtree(temp_repo, ignore_errors=True)

          # === 4. å†™å…¥ç»Ÿè®¡æ—¥å¿— ===
          def write_log():
              date_str = datetime.datetime.now().strftime("%Y-%m-%d")
              log_line = f"{date_str} Added: {total_added_count} lua\n"
              
              # è¿½åŠ æ¨¡å¼å†™å…¥æ—¥å¿—
              try:
                  with open(LOG_FILE, 'a', encoding='utf-8') as f:
                      f.write(log_line)
                  log(f"æ—¥å¿—å·²æ›´æ–°: {log_line.strip()}")
              except Exception as e:
                  log(f"å†™å…¥æ—¥å¿—å¤±è´¥: {e}")

          # === æ‰§è¡Œ ===
          ensure_dir(SAVE_DIR)
          process_repo_search()
          process_luatool()
          process_manifesthub()
          write_log()
          log("æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•")
          EOF

          python collector.py

      - name: Commit and Push
        run: |
          git config --global user.name "AutoBot"
          git config --global user.email "bot@github.com"
          git add lua_downloads/
          # ç¡®ä¿æ·»åŠ æ—¥å¿—æ–‡ä»¶å’Œ marker æ–‡ä»¶
          git add update_log.txt || true
          if [ -f .luatool_imported ]; then git add .luatool_imported; fi
          
          git commit -m "Auto update: $(date +'%Y-%m-%d')" || echo "No changes"
          git push
